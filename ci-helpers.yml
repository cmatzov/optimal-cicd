before_script:
  - |
    apk update
    apk add --no-cache git bash findutils
    docker login $REGISTRY_URI -u $REGISTRY_USER -p $REGISTRY_PASSWD
    echo "https://$GIT_USER:$GIT_PASSWD@gitlab.optim-al.com" > ~/.git-credentials

.scheduled-clear:
  rules: 
    - if: '$CI_PIPELINE_SOURCE == "schedule" && $CLEAR_ENV == "yes"'
  tags: 
    - optimal-novus-runner
  script:
    - /automations/runner/clear-sched.sh

.db_restore:
  rules: 
    - if: '$CI_PIPELINE_SOURCE == "schedule" && $RESTORE_SCRIPT == "yes"'
  tags: 
    - optimal-novus-runner
  script:
    - /automations/runner/opt-test-db-restore.sh

.anal_backend:
  rules:
    - if:
      changes:
        - net/**/*
  tags:
    - optimal-novus-runner
  image: mcr.microsoft.com/dotnet/sdk:6.0
  script:
    - cd ./net
    - dotnet tool restore
    - dotnet build
    - dotnet roslynator analyze | grep "^0 diagnostics found$"
    - dotnet jb inspectcode -o=inspectcode.xml --no-build Optimal.Novus.sln && grep "<Issues />" ./inspectcode.xml

.anal_frontend:
  rules:
    - if:
      changes:
        - js/**/*
  tags:
    - optimal-novus-runner
  image: node:16
  script:
    - cd js
    - npm install
    - npm install -g expo-cli
    - cd apps/mobile
    - npm run install:mobile
    - cd ../..
    - npm run lint

.docker_ikea:
  tags: 
    - optimal-novus-runner
  script:
    - |
      TAG=$(/automations/runner/versioning.sh IK test)
      BRANCH=$(echo "$CI_COMMIT_BRANCH" | sed 's/\//-/g')
      echo $TAG > /automations/runner/${BRANCH}-IKEA-TAG.txt
      devops/pipelines/build/docker-tmp.sh
      PROJECT=ikea TAG=$TAG ENV=test docker-compose build
      PROJECT=ikea TAG=$TAG ENV=test docker-compose push
      git tag $TAG
      git push origin $TAG -o ci.skip
  artifacts:
    paths:
      - /automations/runner/${BRANCH}-IKEA-TAG.txt
  rules:
    - if:
      changes:
        - net/ikea/**/*
        - net/shared/**/*
        - js/package.json
        - js/apps/mobile/package.json
        - js/apps/mobile/src/ikea/**/*
        - js/apps/mobile/src/shared/**/*
        - js/packages/common/package.json
        - js/packages/common/src/ikea-api/**/*
        - js/packages/common/src/shared/**/*
        - js/packages/web/package.json
        - js/packages/web/src/ikea/**/*
        - js/packages/web/src/shared/**/*

.docker_verila:
  tags: 
    - optimal-novus-runner
  script:
    - |
      TAG=$(/automations/runner/versioning.sh VE test)
      BRANCH=$(echo "$CI_COMMIT_BRANCH" | sed 's/\//-/g')
      echo $TAG > /automations/runner/${BRANCH}-VERILA-TAG.txt
      devops/pipelines/build/docker-tmp.sh
      PROJECT=verila TAG=$TAG ENV=test docker-compose build
      PROJECT=verila TAG=$TAG ENV=test docker-compose push
      git tag $TAG
      git push origin $TAG -o ci.skip
  artifacts:
    paths:
      - /automations/runner/${BRANCH}-VERILA-TAG.txt
  rules:
    - if:
      changes:
        - net/verila/**/*
        - net/shared/**/*
        - js/package.json
        - js/apps/mobile/package.json
        - js/apps/mobile/src/verila/**/*
        - js/apps/mobile/src/shared/**/*
        - js/packages/common/package.json
        - js/packages/common/src/verila-api/**/*
        - js/packages/common/src/shared/**/*
        - js/packages/web/package.json
        - js/packages/web/src/verila/**/*
        - js/packages/web/src/shared/**/*
#