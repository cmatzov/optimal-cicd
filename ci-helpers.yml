.scheduled-clear:
  rules: 
    - if: '$CI_PIPELINE_SOURCE == "schedule" && $CLEAR_ENV == "yes"'
  tags: 
    - optimal-novus-runner
  script:
    - chmod +x clear-sched.sh
    - ./clear-sched.sh

.db_restore:
  rules: 
    - if: '$CI_PIPELINE_SOURCE == "schedule" && $RESTORE_SCRIPT == "yes"'
  tags: 
    - optimal-novus-runner
  script:
    - chmod +x opt-test-db-restore.sh
    - ./opt-test-db-restore.sh

.anal_backend:
  stage: build
  rules:
    - if:
      changes:
        - ./net/**/*
  tags:
    - optimal-novus-runner
  image: mcr.microsoft.com/dotnet/sdk:6.0
  script:
    - cd ./net
    - dotnet tool restore
    - dotnet build
    - dotnet roslynator analyze | grep "^0 diagnostics found$"
    - dotnet jb inspectcode -o=inspectcode.xml --no-build Optimal.Novus.sln && grep "<Issues />" ./inspectcode.xml

.anal_frontend:
  stage: build
  rules:
    - if:
      changes:
        - ./js/**/*
  tags:
    - optimal-novus-runner
  image: node:16
  script:
    - cd js
    - npm install
    - npm install -g expo-cli@4.10.0
    - cd apps/mobile
    - npm run install:mobile
    - cd ../..
    - npm run lint

.docker_ikea:
  tags: 
    - optimal-novus-runner
  rules:
    - if:
      changes:
        - ./net/ikea/**/*
        - ./net/shared/**/*
        - ./js/package.json
        - ./js/apps/mobile/package.json
        - ./js/apps/mobile/src/ikea/**/*
        - ./js/apps/mobile/src/shared/**/*
        - ./js/packages/common/package.json
        - ./js/packages/common/src/ikea-api/**/*
        - ./js/packages/common/src/shared/**/*
        - ./js/packages/web/package.json
        - ./js/packages/web/src/ikea/**/*
        - ./js/packages/web/src/shared/**/*
  stage: docker
  script:
    - |
      docker build --arg project=ikea -f docker/server/Dockerfile -t ikea-server .
      docker build --arg project=ikea -f docker/jobs/Dockerfile -t ikea-jobs .
      TAG=$(./versioning.sh IK test)
      echo $TAG > /automations/runner/${CI_COMMIT_BRANCH}-IKEA-TAG.txt
      docker tag ikea-server registry.optim-al.com/repository/optimal/optimal-novus/ikea-server:$TAG
      docker tag ikea-jobs registry.optim-al.com/repository/optimal/optimal-novus/ikea-jobs:$TAG
      docker push ikea-serevr:$TAG
      docker push ikea-jobs:$TAG
      git tag $TAG
      git push origin $TAG -o ci.skip
  artifacts:
    paths:
      - /automations/runner/${CI_COMMIT_BRANCH}-IKEA-TAG.txt

.docker_verila:
  tags: 
    - optimal-novus-runner
  rules:
    - if:
      changes:
        - ./net/verila/**/*
        - ./net/shared/**/*
        - ./js/package.json
        - ./js/apps/mobile/package.json
        - ./js/apps/mobile/src/verila/**/*
        - ./js/apps/mobile/src/shared/**/*
        - ./js/packages/common/package.json
        - ./js/packages/common/src/verila-api/**/*
        - ./js/packages/common/src/shared/**/*
        - ./js/packages/web/package.json
        - ./js/packages/web/src/verila/**/*
        - ./js/packages/web/src/shared/**/*
  stage: docker
  script:
    - |
      docker build --arg project=verila -f docker/server/Dockerfile -t verila-server .
      docker build --arg project=verila -f docker/jobs/Dockerfile -t verila-jobs .
      TAG=$(./versioning.sh VE test)
      echo $TAG > /automations/runner/${CI_COMMIT_BRANCH}-VERILA-TAG.txt
      docker tag verila-server registry.optim-al.com/repository/optimal/optimal-novus/verila-server:$TAG
      docker tag verila-jobs registry.optim-al.com/repository/optimal/optimal-novus/verila-jobs:$TAG
      docker push verila-server:$TAG
      docker push verila-jobs:$TAG
      git tag $TAG
      git push origin $TAG -o ci.skip
  artifacts:
    paths:
      - /automations/runner/${CI_COMMIT_BRANCH}-VERILA-TAG.txt