.clear-test-and-db-restore:
  rules: 
    - if: '$CI_PIPELINE_SOURCE == "schedule" && $SCHEDULED_CLEAR == "yes"'
  tags: 
    - optimal-novus-runner
  script:
    - /automations/runner/clear-test-and-db-restore.sh

.ikea-daily-backups:
  tags:
    - optimal-novus-runner
  environment:
    name: stage
  rules: 
    - if: '$CI_PIPELINE_SOURCE == "schedule" && $BACKUPS == "yes"'
  script:
    - /automations/runner/ikea-daily-backups.sh

.analyze-backend:
  rules:
    - if: '$CI_PIPELINE_SOURCE != "merge_request_event" && $CI_PIPELINE_SOURCE != "schedule" && $CI_COMMIT_TAG == null'
      changes:
        - net/**/*
  tags:
    - optimal-novus-runner
  image: mcr.microsoft.com/dotnet/sdk:8.0
  script:
    - cd ./net
    - dotnet tool restore
    - dotnet build
    - dotnet roslynator analyze > roslynator.txt
    - cat roslynator.txt | grep "^0 diagnostics found$" 
    - dotnet jb inspectcode -o=inspectcode.xml -f="xml" --no-build Optimal.Novus.sln && grep "" ./inspectcode.xml
  artifacts:
    paths:
      - net/inspectcode.xml
      - net/roslynator.txt
    expire_in: 1 day
    when: always
  allow_failure: true

.analyze-frontend:
  rules:
    - if: '$CI_PIPELINE_SOURCE != "merge_request_event" && $CI_PIPELINE_SOURCE != "schedule" && $CI_COMMIT_TAG == null'
      changes:
        - js/**/*
  tags:
    - optimal-novus-runner
  image: node:16
  script:
    - cd js
    - npm install
    - npm install -g expo-cli
    - cd packages/mobile
    - npm run install:mobile
    - cd ../..
    - npm run lint > fe-lint.txt
  artifacts:
    paths:
      - js/fe-lint.txt
    expire_in: 1 day
    when: always
  allow_failure: true
    
.build-ikea:
  tags: 
    - optimal-novus-runner
  environment:
    name: test
  script:
    - |
      git fetch --all
      VERSION=$CI_PIPELINE_ID
      BRANCH=$(echo "$CI_COMMIT_BRANCH" | sed 's/\//-/g')
      export TAG=$VERSION
      echo $TAG > /automations/runner/${BRANCH}-IKEA-TAG.txt
      export PROJECT="ikea"
      devops/pipelines/build/docker-tmp.sh
      docker-compose --env-file /automations/runner/.env config
      docker-compose --env-file /automations/runner/.env build
      docker-compose --env-file /automations/runner/.env push
  rules:
    - if: '$CI_COMMIT_BRANCH != "develop" && $CI_COMMIT_BRANCH != "master" && $CI_COMMIT_BRANCH != "kti" && $CI_PIPELINE_SOURCE != "merge_request_event" && $CI_PIPELINE_SOURCE != "schedule" && $CI_PIPELINE_SOURCE != "web" && $CI_COMMIT_TAG == null'
      changes:
        - net/ikea/**/*
        - net/shared/**/*
        - js/package.json
        - js/apps/mobile/package.json
        - js/apps/mobile/src/ikea/**/*
        - js/apps/mobile/src/shared/**/*
        - js/packages/common/package.json
        - js/packages/common/src/ikea-api/**/*
        - js/packages/common/src/shared/**/*
        - js/packages/web/package.json
        - js/packages/web/src/ikea/**/*
        - js/packages/web/src/shared/**/*
      when: manual

.build-ikea-uat:
  tags: 
    - optimal-novus-runner
  environment:
    name: uat
  script:
    - |
      git fetch --all
      BRANCH=$(echo "$CI_COMMIT_BRANCH" | sed 's/\//-/g')
      VERSION=$CI_PIPELINE_ID
      export TAG=$VERSION
      echo $TAG > /automations/runner/${BRANCH}-IKEA-TAG.txt
      export PROJECT="ikea"
      devops/pipelines/build/docker-tmp.sh
      docker-compose --env-file /automations/runner/.env config
      docker-compose --env-file /automations/runner/.env build
      docker-compose --env-file /automations/runner/.env push
  rules:
    - if: '$CI_PIPELINE_SOURCE == "web" && $CI_COMMIT_BRANCH != "develop" && $CI_COMMIT_BRANCH != "master" && $CI_PIPELINE_SOURCE != "merge_request_event" && $CI_PIPELINE_SOURCE != "schedule" && $CI_COMMIT_BRANCH !~ /^kti\/.*$/ && $CI_COMMIT_TAG == null'
      when: manual

.scheduled-docker-ikea-stage:
  rules: 
    - if: '$CI_PIPELINE_SOURCE == "schedule" && $DEPLOY_STAGE_IKEA == "yes" && $GITLAB_USER_LOGIN =~ $AUTHORIZED_USERS'
  tags: 
    - optimal-novus-runner
  environment:
    name: stage
  script:
    - git fetch --all
    - VERSION=$(/automations/runner/versioning.sh IK Staging)
    - export TAG=$VERSION
    - echo $TAG > /automations/runner/STAGE-IKEA-TAG.txt
    - export PROJECT="ikea"
    - export KC_EXTERNAL_URL="https://stage.optim-al.app/auth"
    - export KC_HOSTNAME_URL="https://stage.optim-al.app"
    - devops/pipelines/build/docker-tmp.sh
    - docker-compose --env-file /automations/runner/.env config
    - docker-compose --env-file /automations/runner/.env build
    - docker-compose --env-file /automations/runner/.env push
    - curl -X POST "https://gitlab.optim-al.com/api/v4/projects/12/repository/tags?tag_name=${TAG}&ref=${CI_COMMIT_BRANCH}&release_description='.'&private_token=${GIT_PASSWD}" --form "variables[CI_SKIP]=true"

.scheduled-docker-ikea-prod:
  rules: 
    - if: '$CI_PIPELINE_SOURCE == "schedule" && $DEPLOY_PROD_IKEA == "yes" && $GITLAB_USER_LOGIN =~ $AUTHORIZED_USERS'
  tags: 
    - optimal-novus-runner
  environment:
    name: production
  script:
    - |
      git fetch --all
      VERSION=$(/automations/runner/versioning.sh IK Production)
      export TAG=$VERSION
      echo $TAG > /automations/runner/master-IKEA-TAG.txt
      export PROJECT="ikea"
      export KC_HOSTNAME_URL="ikea.optim-al.com"
      devops/pipelines/build/docker-tmp.sh
      docker-compose --env-file /automations/runner/.env config
      docker-compose --env-file /automations/runner/.env build
      docker-compose --env-file /automations/runner/.env push
      curl -X POST "https://gitlab.optim-al.com/api/v4/projects/12/repository/tags?tag_name=${TAG}&ref=${CI_COMMIT_BRANCH}&release_description='.'&private_token=${GIT_PASSWD}" --form "variables[CI_SKIP]=true"

.build-verila:
  tags: 
    - optimal-novus-runner
  environment:
    name: test
  script:
    - |
      git fetch --all
      VERSION=$CI_PIPELINE_ID
      export TAG=$VERSION
      BRANCH=$(echo "$CI_COMMIT_BRANCH" | sed 's/\//-/g')
      echo $TAG > /automations/runner/${BRANCH}-VERILA-TAG.txt
      export PROJECT="verila"
      devops/pipelines/build/docker-tmp.sh
      docker-compose --env-file /automations/runner/.env build
      docker-compose --env-file /automations/runner/.env push
  rules:
    - if: '$CI_COMMIT_BRANCH != "develop" && $CI_COMMIT_BRANCH != "master" && $CI_COMMIT_BRANCH != "kti" && $CI_PIPELINE_SOURCE != "merge_request_event" && $CI_PIPELINE_SOURCE != "schedule" && $CI_PIPELINE_SOURCE != "web" && $CI_COMMIT_TAG == null'
      changes:
        - net/verila/**/*
        - net/shared/**/*
        - js/package.json
        - js/apps/mobile/package.json
        - js/apps/mobile/src/verila/**/*
        - js/apps/mobile/src/shared/**/*
        - js/packages/common/package.json
        - js/packages/common/src/verila-api/**/*
        - js/packages/common/src/shared/**/*
        - js/packages/web/package.json
        - js/packages/web/src/verila/**/*
        - js/packages/web/src/shared/**/*
      when: manual

.build-verila-uat:
  tags: 
    - optimal-novus-runner
  environment:
    name: uat
  script:
    - |
      git fetch --all
      BRANCH=$(echo "$CI_COMMIT_BRANCH" | sed 's/\//-/g')
      VERSION=$CI_PIPELINE_ID
      export TAG=$VERSION
      echo $TAG > /automations/runner/${BRANCH}-VERILA-TAG.txt
      export PROJECT="verila"
      devops/pipelines/build/docker-tmp.sh
      docker-compose --env-file /automations/runner/.env build
      docker-compose --env-file /automations/runner/.env push
  rules:
    - if: '$CI_PIPELINE_SOURCE == "web" && $CI_COMMIT_BRANCH != "develop" && $CI_COMMIT_BRANCH != "master" && $CI_PIPELINE_SOURCE != "merge_request_event" && $CI_PIPELINE_SOURCE != "schedule" && $CI_COMMIT_BRANCH !~ /^kti\/.*$/ && $CI_COMMIT_TAG == null'
      when: manual

.scheduled-docker-verila-stage:
  rules: 
    - if: '$CI_PIPELINE_SOURCE == "schedule" && $DEPLOY_STAGE_VERILA == "yes" && $GITLAB_USER_LOGIN =~ $AUTHORIZED_USERS'
  tags: 
    - optimal-novus-runner
  environment:
    name: stage
  script:
    - |
      git fetch --all
      VERSION=$(/automations/runner/versioning.sh VE Staging)
      export TAG=$VERSION
      echo $TAG > /automations/runner/STAGE-VERILA-TAG.txt
      export PROJECT="verila"
      export KC_EXTERNAL_URL="https://stage.optim-al.app/auth"
      export KC_HOSTNAME_URL="https://stage.optim-al.app"
      devops/pipelines/build/docker-tmp.sh
      docker-compose --env-file /automations/runner/.env config
      docker-compose --env-file /automations/runner/.env build
      docker-compose --env-file /automations/runner/.env push
      curl -X POST "https://gitlab.optim-al.com/api/v4/projects/12/repository/tags?tag_name=${TAG}&ref=${CI_COMMIT_BRANCH}&release_description='.'&private_token=${GIT_PASSWD}" --form "variables[CI_SKIP]=true"

.scheduled-docker-verila-prod:
  rules: 
    - if: '$CI_PIPELINE_SOURCE == "schedule" && $DEPLOY_PROD_VERILA == "yes" && $GITLAB_USER_LOGIN =~ $AUTHORIZED_USERS'
  tags: 
    - optimal-novus-runner
  environment:
    name: production
  script:
    - |
      git fetch --all
      VERSION=$(/automations/runner/versioning.sh VE Production)
      export TAG=$VERSION
      echo $TAG > /automations/runner/master-VERILA-TAG.txt
      export PROJECT="verila"
      export KC_HOSTNAME_URL="cus.verila-bg.com"
      devops/pipelines/build/docker-tmp.sh
      docker-compose --env-file /automations/runner/.env config
      docker-compose --env-file /automations/runner/.env build
      docker-compose --env-file /automations/runner/.env push
      curl -X POST "https://gitlab.optim-al.com/api/v4/projects/12/repository/tags?tag_name=${TAG}&ref=${CI_COMMIT_BRANCH}&release_description='.'&private_token=${GIT_PASSWD}" --form "variables[CI_SKIP]=true"

.build-kti:
  tags: 
    - optimal-novus-runner
  environment:
    name: test
  script:
    - |
      git fetch --all
      VERSION=$CI_PIPELINE_ID
      BRANCH=$(echo "$CI_COMMIT_BRANCH" | sed 's/\//-/g')
      export TAG=$VERSION
      echo $TAG > /automations/runner/${BRANCH}-KTI-TAG.txt
      export PROJECT="kti"
      devops/pipelines/build/docker-tmp.sh
      docker-compose --env-file /automations/runner/.env config
      docker-compose --env-file /automations/runner/.env build
      docker-compose --env-file /automations/runner/.env push
  rules:
    - if: '$CI_COMMIT_BRANCH != "develop" && $CI_COMMIT_BRANCH != "master" && $CI_PIPELINE_SOURCE != "merge_request_event" && $CI_PIPELINE_SOURCE != "schedule" && $CI_PIPELINE_SOURCE != "web" && $CI_COMMIT_TAG == null'
      changes:
        - net/kti/**/*
        - js/apps/mobile/src/kti/**/*
        - js/packages/common/src/kti-api/**/*
        - js/packages/web/src/kti/**/*
      when: manual
    - if: '$CI_COMMIT_BRANCH != "develop" && $CI_COMMIT_BRANCH != "master" && $CI_PIPELINE_SOURCE == "web" && $CI_COMMIT_BRANCH =~ /^kti\/.*$/'

.build-kti-uat:
  tags: 
    - optimal-novus-runner
  environment:
    name: uat
  script:
    - |
      git fetch --all
      BRANCH=$(echo "$CI_COMMIT_BRANCH" | sed 's/\//-/g')
      VERSION=$CI_PIPELINE_ID
      export TAG=$VERSION
      echo $TAG > /automations/runner/${BRANCH}-KTI-TAG.txt
      export PROJECT="kti"
      devops/pipelines/build/docker-tmp.sh
      docker-compose --env-file /automations/runner/.env config 
      docker-compose --env-file /automations/runner/.env build
      docker-compose --env-file /automations/runner/.env push
  rules: 
    - if: '$CI_PIPELINE_SOURCE == "schedule" && $DEPLOY_UAT_KTI == "yes"'

.build-kti-stage:
  tags:
    - novus-kti-runner
  environment:
    name: stage
  script:
      git fetch --all
      VERSION=$(/automations/runner/versioning.sh KT Staging)
      export TAG=$VERSION
      echo $TAG > /automations/runner/STAGE-KTI-TAG.txt
      export PROJECT="kti"
      export KC_EXTERNAL_URL="https://testmrp.ktinternational.eu/auth"
      export KC_HOSTNAME_URL="https://testmrp.ktinternational.eu"
      devops/pipelines/build/docker-tmp.sh
      docker-compose --env-file /automations/runner/.env config
      docker-compose --env-file /automations/runner/.env build
      docker-compose --env-file /automations/runner/.env push
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule" && $DEPLOY_STAGE_KTI == "yes" && $GITLAB_USER_LOGIN =~ $AUTHORIZED_USERS'

.build-biovet-service-artifacts:
  tags: 
    - optimal-veteris-runner
  before_script:
    - /automations/runner/buildkit.sh
  script:
    - |
      export TAG=$CI_PIPELINE_ID
      if [[ "$UPDATE_MOBILE" == "false" && "$UPDATE_OFFICE" == "true" ]]; then
        mkdir -p /automations/biovet/tmp/office && chmod 755 /automations/biovet/tmp/office
        ENABLE_DOCKER_BUILDKIT=1 docker buildx build --target office --build-arg environment=test --build-arg version="$TAG" --output type=tar,dest=/automations/biovet/tmp/office/office.tar -f Office/Repository/Dockerfile .
        cd /automations/biovet/tmp/office && tar xf office.tar
        cd app/office && tar -cf office-${TAG}.tar ./* && mv office-${TAG}.tar /automations/biovet/office
        cd /automations/biovet && rm -rf /automations/biovet/tmp/office
      elif [[ "$UPDATE_MOBILE" == "true" && "$UPDATE_OFFICE" == "false" ]]; then
        mkdir -p /automations/biovet/tmp/mobile && chmod 755 /automations/biovet/tmp/mobile
        ENABLE_DOCKER_BUILDKIT=1 docker buildx build --target mobile --build-arg environment=test --build-arg version="$TAG" --output type=tar,dest=/automations/biovet/tmp/mobile/mobile.tar -f Office/Repository/Dockerfile .
        cd /automations/biovet/tmp/mobile && tar xf mobile.tar
        cd app/mobile && tar -cf mobile-${TAG}.tar ./* && mv mobile-${TAG}.tar /automations/biovet/mobile
        cd /automations/biovet && rm -rf /automations/biovet/tmp/mobile
      elif [[ "$UPDATE_MOBILE" == "true" && "$UPDATE_OFFICE" == "true" ]]; then
        mkdir -p /automations/biovet/tmp/both && chmod 755 /automations/biovet/tmp/both
        ENABLE_DOCKER_BUILDKIT=1 docker buildx build --target mobile --build-arg environment=test --build-arg version="$TAG" --output type=tar,dest=/automations/biovet/tmp/both/mobile.tar -f Office/Repository/Dockerfile .
        ENABLE_DOCKER_BUILDKIT=1 docker buildx build --target office --build-arg environment=test --build-arg version="$TAG" --output type=tar,dest=/automations/biovet/tmp/both/office.tar -f Office/Repository/Dockerfile .
        cd /automations/biovet/tmp/both && tar xf mobile.tar && tar xf office.tar
        cd app/mobile && tar -cf mobile-${TAG}.tar ./* && mv mobile-${TAG}.tar /automations/biovet/mobile
        cd ../office && tar -cf office-${TAG}.tar ./* && mv office-${TAG}.tar /automations/biovet/office
        cd /automations/biovet && rm -rf /automations/biovet/tmp/both
      fi
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule" && $DEPLOY_BIOVET == "yes"'

.rollback-biovet-services:
  tags:
    - optimal-veteris-runner
  before_script:
    - /automations/runner/buildkit.sh
  script:
    - |
      if [[ "$ROLLBACK_MOBILE" == "true" && "$ROLLBACK_OFFICE" == "false" ]]; then
        LAST_MOBILE=$(/automations/biovet/last-tag.sh mobile)
        rm -f "${LAST_MOBILE}"
      elif [[ "$ROLLBACK_MOBILE" == "false" && "$ROLLBACK_OFFICE" == "true" ]]; then
        LAST_OFFICE=$(/automations/biovet/last-tag.sh office)
        echo "${LAST_OFFICE}"
        rm -f "${LAST_OFFICE}"
      elif [[ "$ROLLBACK_MOBILE" == "true" && "$ROLLBACK_OFFICE" == "true" ]]; then
        echo "Rollback to Previous Image"
      fi
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule" && $ROLLBACK_BIOVET == "true"'

.docker-build-biovet-repository:
  tags: 
    - optimal-veteris-runner
  before_script:
    - /automations/runner/buildkit.sh
  script:
    - |
      if [[ "$ROLLBACK_MOBILE" == "true" && "$ROLLBACK_OFFICE" == "true" ]]; then
        echo "Rollback to Previous Image"
      else
        LAST_MOBILE=$(/automations/biovet/last-tag.sh mobile)
        LAST_OFFICE=$(/automations/biovet/last-tag.sh office)
        echo $LAST_MOBILE $LAST_OFFICE
        export TAG=$CI_PIPELINE_ID
        mkdir mobile && cd mobile
        cp ${LAST_MOBILE} . && tar xf ${LAST_MOBILE}
        cd ..
        mkdir office && cd office
        cp ${LAST_OFFICE} . && tar xf ${LAST_OFFICE}
        cd ..
        TAG="${TAG}" docker-compose build repository
        TAG="${TAG}" docker-compose push repository
      fi
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule" && $DEPLOY_BIOVET == "yes"' 
    - if: '$CI_PIPELINE_SOURCE == "schedule" && $ROLLBACK_BIOVET == "true"'

# .docker-build-biovet-prod:
#   tags: 
#     - optimal-veteris-runner
#   script:
#     - export TAG=$(/automations/runner/bio-tag.sh)
#     - echo $TAG > /automations/runner/bio-new-tag.txt
#     - git fetch --all
#     - TAG=$TAG ENVIRONMENT=Production docker-compose build
#     - TAG=$TAG ENVIRONMENT=Production docker-compose push
#   rules:
#     - if: '$CI_PIPELINE_SOURCE == "schedule" && $DEPLOY_BIOVET_PROD == "yes"'